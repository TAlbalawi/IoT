(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.SimpleDrawingBoard=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){module.exports={settings:{lineColor:"#aaa",lineSize:5,boardColor:"transparent",historyDepth:10}}},{}],2:[function(require,module,exports){"use strict";var Util=require("./util");var Const=require("./const");function SimpleDrawingBoard(el,options){this._ensureEl(el);this.ev=new Util.Eve;this.el=el;this.ctx=el.getContext("2d");this._elRect={left:0,top:0};this._isDrawing=0;this._timer=null;this._coords={old:{x:0,y:0},oldMid:{x:0,y:0},current:{x:0,y:0}};this._settings={lineColor:null,lineSize:null,boardColor:null,historyDepth:null,isTransparent:null,isDrawMode:null};this._history={prev:new Util.Stack,next:new Util.Stack};this._initHistory();this._initBoard(options)}SimpleDrawingBoard.prototype={constructor:SimpleDrawingBoard,setLineSize:setLineSize,setLineColor:setLineColor,fill:fill,clear:clear,toggleMode:toggleMode,getImg:getImg,setImg:setImg,undo:undo,redo:redo,dispose:dispose,handleEvent:_handleEvent,_ensureEl:_ensureEl,_initBoard:_initBoard,_bindEvents:_bindEvents,_unbindEvents:_unbindEvents,_bindOrUnbindEvents:_bindOrUnbindEvents,_onInputDown:_onInputDown,_onInputMove:_onInputMove,_onInputUp:_onInputUp,_draw:_draw,_getInputCoords:_getInputCoords,_getMidInputCoords:_getMidInputCoords,_setImgByImgSrc:_setImgByImgSrc,_setImgByDrawableEl:_setImgByDrawableEl,_initHistory:_initHistory,_saveHistory:_saveHistory,_restoreFromHistory:_restoreFromHistory};function setLineSize(size){this.ctx.lineWidth=size|0||1;return this}function setLineColor(color){this.ctx.strokeStyle=color;return this}function fill(color){this._saveHistory();this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);this.ctx.fillStyle=color;this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);return this}function clear(){var settings=this._settings;this._saveHistory();if(settings.isTransparent){var oldGCO=this.ctx.globalCompositeOperation;this.ctx.globalCompositeOperation="destination-out";this.fill(this._settings.boardColor);this.ctx.globalCompositeOperation=oldGCO}else{this.fill(this._settings.boardColor)}return this}function toggleMode(){var settings=this._settings;if(settings.isDrawMode){this.setLineColor(settings.boardColor);if(settings.isTransparent){this.ctx.globalCompositeOperation="destination-out"}settings.isDrawMode=0}else{this.setLineColor(settings.lineColor);if(settings.isTransparent){this.ctx.globalCompositeOperation="source-over"}settings.isDrawMode=1}this.ev.trigger("toggleMode",settings.isDrawMode);return this}function getImg(){return this.ctx.canvas.toDataURL("image/png")}function setImg(src,isOverlay,isSkipSaveHistory){isOverlay=isOverlay||false;isSkipSaveHistory=isSkipSaveHistory||false;if(!isSkipSaveHistory){this._saveHistory()}if(typeof src==="string"){this._setImgByImgSrc(src,isOverlay)}else{this._setImgByDrawableEl(src,isOverlay)}return this}function undo(){this._restoreFromHistory(false)}function redo(){this._restoreFromHistory(true)}function dispose(){this._unbindEvents();Util.cAF(this._timer);this._timer=null;this._initHistory();this.ev.trigger("dispose")}function _ensureEl(el){if(!el||typeof el!=="object"||el.tagName.toLowerCase()!=="canvas"){throw new Error("Pass canvas element as first argument.")}}function _initBoard(options){var settings=this._settings=Const.settings;if(options){for(var p in options){settings[p]=options[p]}}if(Util.isTransparent(settings.boardColor)){settings.boardColor="rgba(0,0,0,1)";settings.isTransparent=1}settings.isDrawMode=1;this.ctx.lineCap=this.ctx.lineJoin="round";this.setLineSize(settings.lineSize);this.setLineColor(settings.lineColor);this._bindEvents();this._draw()}function _bindEvents(){this._bindOrUnbindEvents(true)}function _unbindEvents(){this._bindOrUnbindEvents(false)}function _bindOrUnbindEvents(bind){var events=Util.isTouch()?["touchstart","touchmove","touchend","touchcancel","gesturestart"]:["mousedown","mousemove","mouseup","mouseout"];var method=bind?"addEventListener":"removeEventListener";for(var i=0,l=events.length;i<l;i++){this.el[method](events[i],this,false)}}function _draw(){var isSameCoords=this._coords.old.x===this._coords.current.x&&this._coords.old.y===this._coords.current.y;if(this._isDrawing&&!isSameCoords){var currentMid=this._getMidInputCoords(this._coords.current);this.ctx.beginPath();this.ctx.moveTo(currentMid.x,currentMid.y);this.ctx.quadraticCurveTo(this._coords.old.x,this._coords.old.y,this._coords.oldMid.x,this._coords.oldMid.y);this.ctx.stroke();this._coords.old=this._coords.current;this._coords.oldMid=currentMid;this.ev.trigger("draw",this._coords.current)}this._timer=Util.rAF(this._draw.bind(this))}function _onInputDown(ev){this._saveHistory();this._isDrawing=1;var coords=this._getInputCoords(ev);this._coords.current=this._coords.old=coords;this._coords.oldMid=this._getMidInputCoords(coords)}function _onInputMove(ev){this._coords.current=this._getInputCoords(ev)}function _onInputUp(){this._isDrawing=0}function _handleEvent(ev){ev.preventDefault();ev.stopPropagation();switch(ev.type){case"mousedown":case"touchstart":this._onInputDown(ev);break;case"mousemove":case"touchmove":this._onInputMove(ev);break;case"mouseup":case"mouseout":case"touchend":case"touchcancel":case"gesturestart":this._onInputUp();break}}function _getInputCoords(ev){var x,y;if(Util.isTouch()){x=ev.touches[0].pageX;y=ev.touches[0].pageY}else{x=ev.pageX;y=ev.pageY}this._elRect=Util.getAdjustedRect(this.el);this._elScale=Util.getScale(this.el);return{x:(x-this._elRect.left)*this._elScale.x,y:(y-this._elRect.top)*this._elScale.y}}function _getMidInputCoords(coords){return{x:this._coords.old.x+coords.x>>1,y:this._coords.old.y+coords.y>>1}}function _setImgByImgSrc(src,isOverlay){var ctx=this.ctx;var oldGCO=ctx.globalCompositeOperation;var img=new Image;img.onload=function(){ctx.globalCompositeOperation="source-over";isOverlay||ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);ctx.drawImage(img,0,0,ctx.canvas.width,ctx.canvas.height);ctx.globalCompositeOperation=oldGCO};img.src=src}function _setImgByDrawableEl(el,isOverlay){if(!Util.isDrawableEl(el)){return}var ctx=this.ctx;var oldGCO=ctx.globalCompositeOperation;ctx.globalCompositeOperation="source-over";isOverlay||ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);ctx.drawImage(el,0,0,ctx.canvas.width,ctx.canvas.height);ctx.globalCompositeOperation=oldGCO}function _initHistory(){this._history={prev:new Util.Stack,next:new Util.Stack}}function _saveHistory(){var history=this._history;var curImg=this.getImg();var lastImg=history.prev.get(history.prev.size()-1);if(lastImg&&curImg===lastImg){return}while(history.prev.size()>=this._settings.historyDepth){history.prev.shift()}history.prev.push(curImg);history.next=new Util.Stack;this.ev.trigger("save",curImg)}function _restoreFromHistory(goForth){var history=this._history;var pushKey="next";var popKey="prev";if(goForth){pushKey="prev";popKey="next"}var item=history[popKey].pop();if(item==null){return}var curImg=this.getImg();var lastImg=history.next.get(history.next.size()-1);if(!lastImg||lastImg!=curImg){history[pushKey].push(curImg)}this.setImg(item,false,true)}module.exports=SimpleDrawingBoard},{"./const":1,"./util":4}],3:[function(require,module,exports){function Eve(){this._events={}}Eve.prototype={constructor:Eve,on:function(evName,handler){var events=this._events;if(!(evName in events)){events[evName]=[]}events[evName].push(handler)},off:function(evName,handler){var events=this._events;if(!(evName in events)){return}if(!handler){events[evName]=[]}var handlerIdx=events[evName].indexOf(handler);if(handlerIdx>=0){events[evName].splice(handlerIdx,1)}},trigger:function(evName,evData){var events=this._events,handler;if(!(evName in events)){return}var i=0,l=events[evName].length;for(;i<l;i++){handler=events[evName][i];handler.handleEvent?handler.handleEvent.call(this,evData):handler.call(this,evData)}}};module.exports=Eve},{}],4:[function(require,module,exports){(function(global){var Eve=require("./eve");var Stack=require("./stack");var Util={isTouch:isTouch,isTransparent:isTransparent,isDrawableEl:isDrawableEl,getAdjustedRect:getAdjustedRect,getScale:getScale,rAF:rAF(),cAF:cAF(),Eve:Eve,Stack:Stack};function isTouch(){return"ontouchstart"in global.document}function isTransparent(color){color=color.replace(/\s/g,"");if(color==="transparent"){return true}var isRgbaOrHlsaTransparent=color.split(",")[3]==="0)";if(isRgbaOrHlsaTransparent){return true}return false}function isDrawableEl(el){var isDrawable=["img","canvas","video"].indexOf(el.tagName.toLowerCase())!==-1;return isDrawable}function getAdjustedRect(el){var elRect=el.getBoundingClientRect();return{left:elRect.left+global.scrollX,top:elRect.top+global.scrollY}}function getScale(el){var elRect=el.getBoundingClientRect();return{x:el.width/elRect.width,y:el.height/elRect.height}}function rAF(){return(global.requestAnimationFrame||global.webkitRequestAnimationFrame||global.mozRequestAnimationFrame||function(callback){global.setTimeout(callback,1e3/60)}).bind(global)}function cAF(){return(global.cancelAnimationFrame||global.webkitCancelAnimationFrame||global.mozCancelAnimationFrame||function(callback){global.clearTimeout(callback)}).bind(global)}module.exports=Util}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./eve":3,"./stack":5}],5:[function(require,module,exports){function Stack(){this._items=[]}Stack.prototype={constructor:Stack,get:function(i){return this._items[i]},push:function(item){this._items.push(item)},pop:function(){if(this._items.length>0){return this._items.pop()}return null},shift:function(){if(this._items.length>0){return this._items.shift()}return null},size:function(){return this._items.length}};module.exports=Stack},{}]},{},[2])(2)});
